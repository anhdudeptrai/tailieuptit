<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"

      layout:decorate="~{layouts/default_layout}">
<head>
  <title>Trang chủ</title>
</head>
<body>

<th:block layout:fragment="content">

  <section class="hero">
    <div class="container">
      <h1>Chia Sẻ Tài Liệu Học Tập</h1>
      <p>Nơi tập hợp tài liệu học tập chất lượng cao dành cho sinh viên PTIT</p>
      <form class="d-flex justify-content-center" method="GET" th:action="@{/search}">
        <div class="input-group" style="max-width: 600px;">
          <input type="text" class="form-control" name="q"
                 th:value="${searchQuery}"
                 placeholder="Tìm kiếm tài liệu, môn học...">
          <button class="btn btn-primary" type="submit">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </form>
    </div>
  </section>

  <main class="main-content">
    <div class="container">

      <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert">
      </div>

      <section class="mb-5" th:if="${categories != null and not #lists.isEmpty(categories)}">
        <h2 class="section-title">
          <i class="fas fa-th-large"></i> Danh Mục Tài Liệu
        </h2>
        <div class="row g-4">
          <div class="col-lg-4 col-md-6" th:each="category, iterStat : ${categories}">
            <a th:href="@{/category/{slug}(slug=${category.slug})}"
               class="category-card">
            </a>
          </div>
        </div>
      </section>

      <section>
        <h2 class="section-title">
          <i class="fas fa-file-alt"></i>
          <span th:text="${pageTitle} ?: 'Tài Liệu Mới Nhất'">Tài Liệu Mới Nhất</span>
        </h2>

        <div class="row g-4" th:if="${documents != null and documents.hasContent()}">
          <div class="col-lg-4 col-md-6" th:each="doc : ${documents.content}">
            <div class="card document-card">

              <div th:switch="${doc.mimeType}">

                <th:block th:case="'application/pdf'">
                  <div class="document-header header-pdf">
                    <i class="fas fa-file-pdf"></i>
                  </div>
                </th:block>

                <th:block th:case="'application/msword'">
                  <div class="document-header header-word">
                    <i class="fas fa-file-word"></i>
                  </div>
                </th:block>
                <th:block th:case="'application/vnd.openxmlformats-officedocument.wordprocessingml.document'">
                  <div class="document-header header-word">
                    <i class="fas fa-file-word"></i>
                  </div>
                </th:block>

                <th:block th:case="'application/vnd.ms-excel'">
                  <div class="document-header header-excel">
                    <i class="fas fa-file-excel"></i>
                  </div>
                </th:block>
                <th:block th:case="'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'">
                  <div class="document-header header-excel">
                    <i class="fas fa-file-excel"></i>
                  </div>
                </th:block>

                <th:block th:case="'application/vnd.ms-powerpoint'">
                  <div class="document-header header-ppt">
                    <i class="fas fa-file-powerpoint"></i>
                  </div>
                </th:block>
                <th:block th:case="'application/vnd.openxmlformats-officedocument.presentationml.presentation'">
                  <div class="document-header header-ppt">
                    <i class="fas fa-file-powerpoint"></i>
                  </div>
                </th:block>

                <th:block th:case="'text/plain'">
                  <div class="document-header header-default">
                    <i class="fas fa-file-alt"></i>
                  </div>
                </th:block>

                <th:block th:case="*">
                  <div class="document-header header-default">
                    <i class="fas fa-file"></i>
                  </div>
                </th:block>

              </div>

              <div class="card-body">
                <h5 class="card-title" th:text="${doc.title}">Document Title</h5>

                <div class="text-muted mb-2">
                  <small>
                    <i class="fas fa-user"></i>
                    <span th:text="${doc.authorFullName} ?: 'Anonymous'">User</span> |
                    <i class="fas fa-tag"></i>
                    <span th:text="${doc.categoryName} ?: 'Khác'">Category</span>
                  </small>
                </div>

                <div class="d-flex justify-content-between text-black-50 mb-3">

                  <div title="Lượt xem" class="d-flex align-items-center">
                    <i class="fas fa-eye me-1"></i>
                    <small th:text="${doc.viewsCount}">0</small>
                  </div>

                  <div title="Lượt tải" class="d-flex align-items-center">
                    <i class="fas fa-download me-1"></i>
                    <small th:text="${doc.downloadCount}">0</small>
                  </div>

                  <div title="Đánh giá trung bình" class="d-flex align-items-center">
                    <i class="fas fa-star me-1" style="color: #ffc107;"></i>
                    <small th:text="${doc.averageRating}">0.0</small>
                  </div>

                  <div title="Số bình luận" class="d-flex align-items-center">
                    <i class="fas fa-comment me-1"></i>
                    <small th:text="${doc.commentsCount}">0</small>
                  </div>
                </div>
                <p class="card-text mb-3">
                  <small class="text-muted">
                    <i class="fas fa-clock me-1"></i>
                    Đăng tải:
                    <span th:text="${#dates.format(doc.createdAt, 'dd/MM/yyyy')}">dd/MM/yyyy</span>
                  </small>
                </p>
                <div class="d-flex gap-2">
                    <a th:href="@{/api/documents/download/{id}(id=${doc.id})}"
                       class="btn btn-success btn-sm flex-fill">
                      <i class="fas fa-download"></i> Tải về
                    </a>
                    <a th:href="@{/document/{id}(id=${doc.id})}"
                       class="btn btn-info btn-sm flex-fill">
                      <i class="fas fa-eye"></i> Xem
                    </a>
                  <button sec:authorize="hasRole('ADMIN')"
                          class="btn btn-danger btn-sm"
                          th:onclick="confirmDelete([[${doc.id}]], '[[${doc.title}]]')"
                          type="button">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div th:if="${documents == null or not documents.hasContent()}"
             class="text-center py-5">
          <a sec:authorize="isAuthenticated()" th:href="@{/document/upload}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Thêm tài liệu
          </a>
        </div>
      </section>
    </div>
  </main>

</th:block>

<th:block layout:fragment="scripts">
  <script sec:authorize="hasRole('ADMIN')" th:inline="javascript">
    function confirmDelete(documentId, documentTitle) {
      if (confirm('Xác nhận xóa tài liệu "' + documentTitle + '"?')) {

        // Lấy CSRF token (nếu bạn bật)
        const token = document.querySelector('meta[name="_csrf"]');
        const headers = { 'Content-Type': 'application/json' };
        // if (token) { headers['X-CSRF-TOKEN'] = token.content; }

        // Gọi API: DELETE /api/admin/documents/{id}
        fetch('/api/admin/documents/' + documentId, {
          method: 'DELETE',
          headers: headers
        })
      .then(response => {
          if (response.ok) {
            alert('Xóa thành công!');
            window.location.reload();
          } else {
            response.json().then(data => alert('Lỗi: ' + (data.message || 'Không thể xóa')));
          }
        })
                .catch(error => alert('Đã xảy ra lỗi hệ thống.'));
      }
    }
  </script>
</th:block>

</body>
</html>